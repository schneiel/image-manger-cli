version: '3.8'

services:
  # Main ImageManager application
  imagemanager:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: imagemanager:latest
    container_name: imagemanager_app
    restart: unless-stopped
    volumes:
      # Mount directories for image processing
      - ./test_images:/app/input:ro
      - ./output:/app/output
      - ./config:/app/config:ro
      - ./logs:/app/logs
    environment:
      - LOG_LEVEL=info
      - CONFIG_PATH=/app/config/config.yaml
    networks:
      - imagemanager_network
    profiles:
      - production

  # Development environment with hot reload
  imagemanager-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    image: imagemanager:dev
    container_name: imagemanager_dev
    volumes:
      # Mount source code for development
      - .:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
      # Mount directories for testing
      - ./test_images:/app/test_images:ro
      - ./output:/app/output
      - ./logs:/app/logs
    environment:
      - GO_ENV=development
      - CGO_ENABLED=1
      - LOG_LEVEL=debug
    working_dir: /app
    command: tail -f /dev/null  # Keep container running for development
    networks:
      - imagemanager_network
    profiles:
      - development

  # Testing environment
  imagemanager-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: testing
    image: imagemanager:test
    container_name: imagemanager_test
    volumes:
      - .:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
      - ./test_results:/app/test_results
    environment:
      - GO_ENV=test
      - CGO_ENABLED=1
    working_dir: /app
    command: make test
    networks:
      - imagemanager_network
    profiles:
      - testing

  # CI/CD environment for quality checks
  imagemanager-ci:
    build:
      context: .
      dockerfile: Dockerfile
      target: ci
    image: imagemanager:ci
    container_name: imagemanager_ci
    volumes:
      - .:/app:ro
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
      - ./ci_results:/app/ci_results
    environment:
      - GO_ENV=ci
      - CGO_ENABLED=0
    working_dir: /app
    command: make ci-full
    networks:
      - imagemanager_network
    profiles:
      - ci

  # Quality analysis environment
  imagemanager-qa:
    build:
      context: .
      dockerfile: Dockerfile
      target: qa
    image: imagemanager:qa
    container_name: imagemanager_qa
    volumes:
      - .:/app
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
      - ./qa_results:/app/qa_results
    environment:
      - GO_ENV=qa
      - CGO_ENABLED=1
    working_dir: /app
    command: make quality-audit
    networks:
      - imagemanager_network
    profiles:
      - qa

volumes:
  go_mod_cache:
    driver: local
  go_build_cache:
    driver: local
networks:
  imagemanager_network:
    driver: bridge
